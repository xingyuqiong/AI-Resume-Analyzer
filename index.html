<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>AI 简历分析系统</title>

  <style>
    /* 浅色主题 + 保留你之前的布局结构 */

    body {
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",
                   "PingFang SC","Microsoft YaHei",sans-serif;
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 24px;
      background: #f3f4f6;   /* 浅灰背景 */
      color: #111827;         /* 深色文字 */
    }

    h1 { margin-bottom: 8px; font-size: 26px; }
    h2 { margin: 0 0 12px; font-size: 20px; }

    section {
      margin-top: 28px;
      padding: 24px;
      border-radius: 14px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 20px rgba(15,23,42,0.05);
    }

    label { display: block; margin-bottom: 8px; font-weight: 500; }

    input[type="file"] { margin-bottom: 12px; }

    textarea {
      width: 100%;
      min-height: 180px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #111827;
      resize: vertical;
      font-size: 14px;
      line-height: 1.5;
      font-family: "JetBrains Mono","Fira Code","Consolas","SF Mono",monospace;
    }

    button {
      margin-top: 8px;
      padding: 8px 18px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-size: 14px;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    pre {
      margin-top: 12px;
      padding: 12px 14px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      max-height: 360px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 14px;
      line-height: 1.5;
      font-family: "JetBrains Mono","Fira Code","Consolas","SF Mono",monospace;
    }

    small {
      color: #6b7280;
    }
  </style>
</head>
<body>
  <h1>AI 简历分析系统</h1>
  <p>流程：上传 PDF 简历 → 查看 AI 解析结果 → 输入岗位 JD 做匹配。</p>

  <!-- 1. 上传 + 解析简历 -->
  <section id="upload-section">
    <h2>第一步：上传简历并解析</h2>
    <label for="resumeFile">选择简历 PDF 文件：</label>
    <input type="file" id="resumeFile" accept="application/pdf" />
    <br />
    <button id="btnUpload">上传并解析简历</button>
    <small>上传完成后，将展示基本信息、教育经历、各类经历、获奖情况、技能与求职意向。</small>
    <pre id="uploadResult">请先上传一份 PDF 简历。</pre>
  </section>

  <!-- 2. JD 匹配 -->
  <section id="match-section">
    <h2>第二步：输入岗位 JD，进行匹配评分</h2>
    <label for="jobDesc">岗位描述（JD）：</label>
    <textarea
      id="jobDesc"
      placeholder="例如：负责大模型相关的数据分析与评估，熟悉 Python、SQL，有互联网实习经验……"
    ></textarea>
    <button id="btnMatch" disabled>开始匹配分析</button>
    <small>匹配结果会展示综合匹配得分、教育和经验匹配度、优势亮点与风险提示。</small>
    <pre id="matchResult">请先完成第一步上传简历。</pre>
  </section>

  <script>
    // 本地开发时：后端跑在 http://127.0.0.1:8000
    const API_BASE = "http://127.0.0.1:8000";

    // 内部使用，不在界面上展示
    let currentResumeId = null;

    function pretty(obj) {
      return JSON.stringify(obj, null, 2);
    }

    // 把后端 parsed 转成带中文 key 的结构，用于展示
    function buildDisplayUpload(data) {
      const parsed = data.parsed || {};

      return {
        "简历文件名": data.filename,
        "基本信息": parsed.basic_info || {},
        "教育经历": parsed.education || [],
        "工作经历": parsed.work_experiences || parsed.experiences || [],
        "项目经历": parsed.project_experiences || [],
        "校园经历": parsed.campus_experiences || [],
        "获奖情况": parsed.awards || [],
        "技能": parsed.skills || [],
        "求职意向": parsed.desired_positions || []
      };
    }

    // 把后端 match_result 转成中文 key 的展示结构
    function buildDisplayMatch(data, jdText) {
      const match = data.match_result || {};
      return {
        "岗位描述": data.job_description || jdText,
        "综合匹配得分": match.overall_score ?? null,
        "教育背景匹配度": match.education_match_score ?? null,
        "经验背景匹配度": match.experience_match_score ?? null,
        "优势亮点": match.highlights || [],
        "缺点提示": match.risks || [],
        "分析说明": match.reasoning || ""
      };
    }

    // 1) 上传简历
    document.getElementById("btnUpload").onclick = async () => {
      const fileInput = document.getElementById("resumeFile");
      const resultBox = document.getElementById("uploadResult");

      if (!fileInput.files[0]) {
        alert("请先选择一个 PDF 简历文件");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      resultBox.textContent = "正在上传和解析简历，请稍候……";

      try {
        const resp = await fetch(`${API_BASE}/resume/upload`, {
          method: "POST",
          body: formData,
        });

        const data = await resp.json();
        if (!resp.ok) {
          resultBox.textContent = "解析失败：\n" + pretty(data);
          return;
        }

        // 记录当前简历的 id，只在前端内部使用，不展示给用户
        currentResumeId = data.resume_id;
        document.getElementById("btnMatch").disabled = false;

        const displayObj = buildDisplayUpload(data);

        resultBox.textContent =
          "简历上传并解析成功，AI 提取的关键信息如下：\n\n" +
          pretty(displayObj);
      } catch (err) {
        console.error(err);
        resultBox.textContent = "请求失败：" + err;
      }
    };

    // 2) 简历与 JD 匹配
    document.getElementById("btnMatch").onclick = async () => {
      const resultBox = document.getElementById("matchResult");
      const jdText = document.getElementById("jobDesc").value.trim();

      if (!currentResumeId) {
        alert("请先上传简历，完成第一步解析。");
        return;
      }
      if (!jdText) {
        alert("请填写岗位 JD 文本");
        return;
      }

      resultBox.textContent = "正在根据简历和 JD 进行匹配分析，请稍候……";

      try {
        const resp = await fetch(`${API_BASE}/resume/match`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            // 这里仍然用第一步的 id，但不在页面展示
            resume_id: currentResumeId,
            job_description: jdText,
          }),
        });

        const data = await resp.json();
        if (!resp.ok) {
          resultBox.textContent = "匹配失败：\n" + pretty(data);
          return;
        }

        const displayObj = buildDisplayMatch(data, jdText);

        resultBox.textContent =
          "匹配分析完成，结果如下：\n\n" + pretty(displayObj);
      } catch (err) {
        console.error(err);
        resultBox.textContent = "请求失败：" + err;
      }
    };
  </script>
</body>
</html>
